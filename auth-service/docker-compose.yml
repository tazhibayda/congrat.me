version: "3.9"
services:
  mongo:
    image: mongo:6
    ports: ["27017:27017"]
  redis:
    image: redis:7
    ports: ["6379:6379"]
  rabbit:
    image: rabbitmq:3-management
    ports: ["5672:5672", "15672:15672"]

  # ðŸ”µ Datadog Agent
  datadog-agent:
    image: gcr.io/datadoghq/agent:latest
    environment:
      # Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ:
      DD_API_KEY: ${DD_API_KEY}
      DD_SITE: ${DD_SITE}
      DD_ENV: dev
      DD_APM_ENABLED: "true"                  # APM/Traces
      DD_APM_NON_LOCAL_TRAFFIC: "true"        # Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð¸Ð· Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
      DD_LOGS_ENABLED: "true"                 # ÑÐ±Ð¾Ñ€ Ð»Ð¾Ð³Ð¾Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
      DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL: "true"
      DD_PROMETHEUS_SCRAPE: "true"
    ports:
      - "8126:8126/tcp"   # APM intake (agent â† app)
      - "8125:8125/udp"   # DogStatsD (metrics, ÐµÑÐ»Ð¸ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±Ð¸Ñ‚ÑÑ)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro   # Ð»Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    restart: unless-stopped

  auth:
    build: .
    depends_on: [mongo, redis, rabbit, datadog-agent]
    ports: ["8080:8080"]
    environment:
      APP_PORT: "8080"
      MONGO_URI: "mongodb://mongo:27017"
      MONGO_DB: "auth_db"
      REDIS_ADDR: "redis:6379"
      RABBIT_URL: "amqp://guest:guest@rabbit:5672/"
      JWT_ACTIVE_KID: "kid-local-A"
      JWT_ACTIVE_PRIVATE_PATH: "/run/keys/active.pem"
      JWT_NEXT_KID: "kid-local-N"
      JWT_NEXT_PRIVATE_PATH: "/run/keys/next.pem"
      RATE_LIMIT_PER_MIN: "5"
      GOOGLE_REDIRECT_URI: "https://auth.tazhibayda.tech/api/auth/google/callback"
      # ðŸ”¶ Datadog correlation / APM Ñ‚ÐµÐ³Ð¸ Ð´Ð»Ñ ÑÐµÑ€Ð²Ð¸ÑÐ°
      DD_ENV: "dev"
      DD_SERVICE: "auth-service"
      DD_VERSION: "0.1.0"
      # ÐºÑƒÐ´Ð° ÑÐ»Ð°Ñ‚ÑŒ Ñ‚Ñ€ÐµÐ¹ÑÑ‹ (dd-trace-go ÑÐ°Ð¼ Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ ÑÑ‚Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ)
      DD_AGENT_HOST: "datadog-agent"
      DD_TRACE_AGENT_PORT: "8126"
      # DogStatsD
      DD_DOGSTATSD_PORT: "8125"
    labels:
      # ðŸ”¹ ÐÐ²Ñ‚Ð¾ÑÐºÑ€ÐµÐ¹Ð¿ Prometheus Ð°Ð³ÐµÐ½Ñ‚Ð¾Ð¼ Ñ /metrics
      com.datadoghq.ad.check_names: '["openmetrics"]'
      com.datadoghq.ad.init_configs: '[{}]'
      com.datadoghq.ad.instances: |
        [
          {"prometheus_url": "http://%%host%%:8080/metrics", "namespace":"auth", "metrics":["*"]}
        ]
      com.datadoghq.ad.logs: >
          [
            {"source":"go","service":"auth-service"}
          ]
    volumes:
      - ./keys:/run/keys:ro
